<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>çˆªçˆªéµç›¤å­—æ ¹ç¢¼ç”¢ç”Ÿå™¨</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3348;
    --text:#e4e6f0;--text2:#9499b3;--accent:#6c7ee1;--accent-hover:#8490eb;
    --success:#4ade80;--error:#f87171;--radius:12px;
  }
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    background:var(--bg);color:var(--text);min-height:100vh;
    display:flex;flex-direction:column;align-items:center;padding:2rem 1rem;
  }
  h1{font-size:1.75rem;font-weight:700;margin-bottom:.25rem}
  .subtitle{color:var(--text2);font-size:.9rem;margin-bottom:2rem}
  .container{width:100%;max-width:640px}

  .format-selector{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1.5rem}
  .format-btn{
    padding:1rem;border-radius:var(--radius);border:2px solid var(--border);
    background:var(--surface);color:var(--text);cursor:pointer;
    transition:all .2s;text-align:left;
  }
  .format-btn:hover{border-color:var(--accent);background:var(--surface2)}
  .format-btn.active{border-color:var(--accent);background:rgba(108,126,225,.12)}
  .format-btn strong{display:block;font-size:.95rem;margin-bottom:.25rem}
  .format-btn span{font-size:.78rem;color:var(--text2);line-height:1.4}

  .drop-zone{
    border:2px dashed var(--border);border-radius:var(--radius);
    padding:2.5rem 1.5rem;text-align:center;cursor:pointer;
    transition:all .2s;background:var(--surface);margin-bottom:1rem;
    position:relative;
  }
  .drop-zone:hover,.drop-zone.dragover{border-color:var(--accent);background:var(--surface2)}
  .drop-zone p{color:var(--text2);font-size:.9rem;margin-top:.5rem}
  .drop-zone .icon{font-size:2rem;margin-bottom:.5rem;display:block}
  .drop-zone input[type=file]{
    position:absolute;inset:0;opacity:0;cursor:pointer;
  }

  .file-info{
    background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
    padding:.75rem 1rem;margin-bottom:1rem;display:none;
    font-size:.85rem;color:var(--text2);
  }
  .file-info.visible{display:flex;align-items:center;gap:.5rem}
  .file-info .name{color:var(--text);font-weight:500;flex:1}
  .file-info .size{color:var(--text2)}
  .file-info .remove{
    background:none;border:none;color:var(--error);cursor:pointer;
    font-size:1.1rem;padding:0 .25rem;
  }

  .btn-primary{
    width:100%;padding:.85rem;border:none;border-radius:var(--radius);
    background:var(--accent);color:#fff;font-size:.95rem;font-weight:600;
    cursor:pointer;transition:all .2s;margin-bottom:1rem;
  }
  .btn-primary:hover:not(:disabled){background:var(--accent-hover)}
  .btn-primary:disabled{opacity:.4;cursor:not-allowed}

  .output{
    background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
    padding:1rem;display:none;
  }
  .output.visible{display:block}
  .output h3{font-size:.9rem;margin-bottom:.75rem;color:var(--text2)}
  .stats{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1rem}
  .stat{
    background:var(--surface2);border-radius:8px;padding:.6rem .75rem;
  }
  .stat .label{font-size:.72rem;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
  .stat .value{font-size:1.1rem;font-weight:600;margin-top:.15rem}

  .download-row{display:flex;gap:.5rem}
  .btn-download{
    flex:1;padding:.65rem;border:1px solid var(--border);border-radius:8px;
    background:var(--surface2);color:var(--text);font-size:.85rem;
    cursor:pointer;transition:all .2s;text-align:center;font-weight:500;
  }
  .btn-download:hover{border-color:var(--accent);background:rgba(108,126,225,.1)}

  .log{
    margin-top:1rem;background:var(--surface);border:1px solid var(--border);
    border-radius:var(--radius);padding:.75rem;max-height:200px;overflow-y:auto;
    font-family:"SF Mono",Monaco,Consolas,monospace;font-size:.78rem;
    color:var(--text2);line-height:1.6;display:none;
  }
  .log.visible{display:block}
  .log .error{color:var(--error)}
  .log .success{color:var(--success)}

  .progress-bar{
    height:3px;background:var(--border);border-radius:2px;margin-bottom:1rem;
    overflow:hidden;display:none;
  }
  .progress-bar.visible{display:block}
  .progress-bar .fill{
    height:100%;background:var(--accent);width:0%;
    transition:width .3s ease;
  }

  .source-links{
    background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
    padding:.85rem 1rem;margin-bottom:1.5rem;font-size:.82rem;color:var(--text2);line-height:1.7;
  }
  .source-links p{margin-bottom:.35rem;font-weight:500;color:var(--text)}
  .source-links ul{list-style:none;padding:0}
  .source-links a{color:var(--accent);text-decoration:none;transition:color .2s}
  .source-links a:hover{color:var(--accent-hover);text-decoration:underline}

  .format-sample{
    background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
    margin-bottom:1.5rem;overflow:hidden;
  }
  .format-sample summary{
    list-style:none;cursor:pointer;padding:.85rem 1rem;font-weight:600;color:var(--text);
    display:flex;align-items:center;justify-content:space-between;
  }
  .format-sample summary::-webkit-details-marker{display:none}
  .format-sample summary::after{content:"â–¸";color:var(--text2);transition:transform .2s ease}
  .format-sample[open] summary::after{transform:rotate(90deg)}
  .format-sample .sample-content{padding:0 1rem 1rem}
  .sample-grid{display:grid;grid-template-columns:1fr;gap:.75rem}
  .sample-card{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:.7rem}
  .sample-card h4{font-size:.82rem;margin-bottom:.45rem;color:var(--text2)}
  .sample-card pre{
    margin:0;white-space:pre-wrap;word-break:break-word;
    font-family:"SF Mono",Monaco,Consolas,monospace;font-size:.76rem;line-height:1.55;color:var(--text)
  }

  footer{margin-top:3rem;color:var(--text2);font-size:.75rem;text-align:center}
  footer a{color:var(--accent);text-decoration:none}
</style>
</head>
<body>

<div class="container">
  <h1>çˆªçˆªéµç›¤å­—æ ¹ç¢¼ç”¢ç”Ÿå™¨</h1>
  <p class="subtitle">é¸æ“‡æ ¼å¼ â†’ åŒ¯å…¥æª”æ¡ˆ â†’ ä¸‹è¼‰äºŒé€²ä½ç¢¼è¡¨</p>

  <div class="format-selector">
    <button class="format-btn active" data-format="v1">
      <strong>V1 æ ¼å¼</strong>
      <span>å­—æ ¹ç¢¼ä¾†æºæª”ï¼ˆV1ï¼‰<br>TAB åˆ†éš” Â· BEGIN_TABLE / END_TABLE</span>
    </button>
    <button class="format-btn" data-format="v2">
      <strong>V2 æ ¼å¼</strong>
      <span>å­—æ ¹ç¢¼ä¾†æºæª”ï¼ˆV2ï¼‰<br>ç©ºæ ¼åˆ†éš” Â· %chardef begin / end</span>
    </button>
  </div>

  <div class="source-links">
    <p>ä»¥å˜¸è¦ç±³å­—ç¢¼ç‚ºä¾‹</p>
    <ul>
      <li><strong>V1</strong>ï¼š<a href="https://github.com/jdh8/ibus-boshiamy/blob/master/boshiamy.txt" target="_blank" rel="noopener">V1 ä¾†æºæª”ï¼ˆTXTï¼‰</a></li>
      <li><strong>V2</strong>ï¼š<a href="https://github.com/chinese-opendesktop/cin-tables/blob/master/boshiamy.cin" target="_blank" rel="noopener">V2 ä¾†æºæª”ï¼ˆCINï¼‰</a></li>
      <li><strong>é—œè¯è©</strong>ï¼š<a href="https://boshiamy.com/download_tools.php#tab_tab5" target="_blank" rel="noopener">ä¸‹è¼‰ä½ç½®</a></li>
    </ul>
  </div>

  <details class="format-sample">
    <summary>åŒ¯å…¥æª”æ¡ˆæ ¼å¼ç¤ºæ„ï¼ˆé»æ“Šå±•é–‹ï¼‰</summary>
    <div class="sample-content">
      <div class="sample-grid">
        <div class="sample-card">
          <h4>V1 ç¯„ä¾‹ï¼ˆTAB åˆ†éš”ï¼šå­—æ ¹[TAB]è©å¥[TAB]é »ç‡ï¼‰</h4>
          <pre>a	å°	99
aa	å¯¸	100
aa	ä¸¶	99
aaa	é‘«	100
aaa	é¾˜	99
aaa	é‘†	98
aab	é¯	100</pre>
        </div>
        <div class="sample-card">
          <h4>V2 ç¯„ä¾‹ï¼ˆç©ºæ ¼åˆ†éš”ï¼šå­—æ ¹[ç©ºæ ¼]è©å¥ï¼‰</h4>
          <pre>bxv æ•
bxx çˆ¶
bxy é™
by å¢œ
bybp å‡Œ
bybp é™µ
bybpv é™µ
byby é™¸
bye é™¸
bye éš˜</pre>
        </div>
      </div>
    </div>
  </details>

  <div class="drop-zone" id="dropZone">
    <input type="file" id="fileInput" accept=".txt,.cin">
    <span class="icon">ğŸ“‚</span>
    <strong>é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</strong>
    <p id="formatHint">æ”¯æ´ V1 å­—æ ¹ç¢¼æª”ï¼ˆTAB åˆ†éš”æ ¼å¼ï¼‰</p>
  </div>

  <div class="file-info" id="fileInfo">
    <span class="name" id="fileName"></span>
    <span class="size" id="fileSize"></span>
    <button class="remove" id="removeFile" title="ç§»é™¤æª”æ¡ˆ">âœ•</button>
  </div>

  <div class="progress-bar" id="progressBar"><div class="fill" id="progressFill"></div></div>

  <button class="btn-primary" id="buildBtn" disabled>ç”¢ç”Ÿç¢¼è¡¨</button>

  <div class="output" id="output">
    <h3>ç”¢ç”Ÿçµæœ</h3>
    <div class="stats" id="stats"></div>
    <div class="download-row" id="downloads"></div>
  </div>

  <div class="log" id="log"></div>
</div>

<footer>çˆªçˆªéµç›¤å­—æ ¹ç¢¼å·¥å…· Â· ç´”å‰ç«¯è™•ç†ï¼Œæª”æ¡ˆä¸æœƒä¸Šå‚³</footer>

<script>
"use strict";

const MAGIC = new Uint8Array([66,79,83,72,73,65,77,89]); // "BOSHIAMY"
const VERSION = 3;

// â”€â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const formatBtns = document.querySelectorAll(".format-btn");
const dropZone = document.getElementById("dropZone");
const fileInput = document.getElementById("fileInput");
const fileInfoEl = document.getElementById("fileInfo");
const fileNameEl = document.getElementById("fileName");
const fileSizeEl = document.getElementById("fileSize");
const removeFileBtn = document.getElementById("removeFile");
const formatHint = document.getElementById("formatHint");
const buildBtn = document.getElementById("buildBtn");
const outputEl = document.getElementById("output");
const statsEl = document.getElementById("stats");
const downloadsEl = document.getElementById("downloads");
const logEl = document.getElementById("log");
const progressBar = document.getElementById("progressBar");
const progressFill = document.getElementById("progressFill");

let selectedFormat = "v1";
let loadedFile = null;
let loadedText = null;

// â”€â”€â”€ Format selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
formatBtns.forEach(btn => {
  btn.addEventListener("click", () => {
    formatBtns.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    selectedFormat = btn.dataset.format;
    formatHint.textContent = selectedFormat === "v1"
      ? "æ”¯æ´ V1 å­—æ ¹ç¢¼æª”ï¼ˆTAB åˆ†éš”æ ¼å¼ï¼‰"
      : "æ”¯æ´ V2 å­—æ ¹ç¢¼æª”ï¼ˆç©ºæ ¼åˆ†éš” %chardef æ ¼å¼ï¼‰";
    resetOutput();
  });
});

// â”€â”€â”€ File handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.classList.remove("dragover");
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener("change", () => {
  if (fileInput.files.length) handleFile(fileInput.files[0]);
});
removeFileBtn.addEventListener("click", () => {
  loadedFile = null;
  loadedText = null;
  fileInput.value = "";
  fileInfoEl.classList.remove("visible");
  buildBtn.disabled = true;
  resetOutput();
});

function handleFile(file) {
  loadedFile = file;
  fileNameEl.textContent = file.name;
  fileSizeEl.textContent = formatBytes(file.size);
  fileInfoEl.classList.add("visible");
  resetOutput();

  const reader = new FileReader();
  reader.onload = () => {
    loadedText = reader.result;
    buildBtn.disabled = false;
    log(`âœ“ å·²è¼‰å…¥ ${file.name}ï¼ˆ${formatBytes(file.size)}ï¼‰`, "success");
  };
  reader.onerror = () => log("è®€å–æª”æ¡ˆå¤±æ•—", "error");
  reader.readAsText(file, "utf-8");
}

// â”€â”€â”€ Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildBtn.addEventListener("click", () => {
  if (!loadedText) return;
  resetOutput();
  showProgress(0);

  try {
    const t0 = performance.now();

    log("è§£ææª”æ¡ˆ...");
    showProgress(10);
    const raw = selectedFormat === "v1" ? parseBoshiamyV1(loadedText) : parseBoshiamyV2(loadedText);
    log(`  åŸå§‹åˆ—æ•¸: ${raw.length}`);
    showProgress(30);

    log("æ¸…ç†èˆ‡å»é‡...");
    const rows = cleanRows(raw);
    log(`  æ¸…ç†å¾Œåˆ—æ•¸: ${rows.length}`);
    showProgress(50);

    log("å»ºæ§‹ Trie...");
    const nodes = buildTrie(rows);
    log(`  ç¯€é»æ•¸: ${nodes.length}`);
    showProgress(70);

    log("ç”¢ç”ŸäºŒé€²ä½ç¢¼è¡¨...");
    const { buffer, stats } = writeBinaryTable(nodes);
    showProgress(90);

    const csvBlob = generateCSV(rows);
    const elapsed = ((performance.now() - t0) / 1000).toFixed(2);

    log(`âœ“ å®Œæˆï¼è€—æ™‚ ${elapsed}sï¼Œç¢¼è¡¨å¤§å° ${formatBytes(buffer.byteLength)}`, "success");
    showProgress(100);

    displayResults(stats, rows.length, nodes.length, buffer, csvBlob);
  } catch (err) {
    log(`âœ— éŒ¯èª¤: ${err.message}`, "error");
    console.error(err);
  }
});

// â”€â”€â”€ V1 Parser: source v1 txt (TAB-separated) â”€â”€â”€â”€â”€â”€â”€
function parseBoshiamyV1(text) {
  const rows = [];
  let inTable = false;

  for (const line of text.split("\n")) {
    const stripped = line.replace(/\r$/, "");
    if (stripped === "BEGIN_TABLE") { inTable = true; continue; }
    if (stripped === "END_TABLE") break;
    if (!inTable || stripped.startsWith("###") || !stripped) continue;

    const parts = stripped.split("\t");
    if (parts.length < 3) continue;
    const key = parts[0].trim();
    const phrase = parts[1].trim();
    const freqStr = parts[2].trim();
    if (!key || !phrase || !/^\d+$/.test(freqStr)) continue;

    const freq = Math.max(0, Math.min(255, parseInt(freqStr, 10)));
    rows.push({ key, phrase: phrase.normalize("NFC"), freq });
  }
  return rows;
}

// â”€â”€â”€ V2 Parser: source v2 cin (%chardef) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseBoshiamyV2(text) {
  const rows = [];
  let inChardef = false;
  const freqCounter = new Map();

  for (const line of text.split("\n")) {
    const stripped = line.replace(/\r$/, "");
    if (stripped === "%chardef begin") { inChardef = true; continue; }
    if (stripped === "%chardef end") break;
    if (!inChardef || stripped.startsWith("#") || !stripped) continue;

    const idx = stripped.indexOf(" ");
    if (idx < 0) continue;
    const key = stripped.slice(0, idx);
    const phrase = stripped.slice(idx + 1);
    if (!key || !phrase) continue;

    const count = freqCounter.get(key) || 0;
    const freq = Math.max(0, Math.min(255, 100 - count));
    freqCounter.set(key, count + 1);

    rows.push({ key, phrase: phrase.normalize("NFC"), freq });
  }
  return rows;
}

// â”€â”€â”€ Clean rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cleanRows(raw) {
  const merged = new Map();
  for (const { key, phrase, freq } of raw) {
    const pairKey = key + "\0" + phrase;
    const prev = merged.get(pairKey);
    if (prev === undefined || freq > prev.freq) {
      merged.set(pairKey, { key, phrase, freq });
    }
  }
  const rows = Array.from(merged.values());
  rows.sort((a, b) => {
    if (a.key < b.key) return -1;
    if (a.key > b.key) return 1;
    if (b.freq !== a.freq) return b.freq - a.freq;
    if (a.phrase < b.phrase) return -1;
    if (a.phrase > b.phrase) return 1;
    return 0;
  });
  return rows;
}

// â”€â”€â”€ Build Trie â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTrie(rows) {
  const nodes = [{ children: new Map(), candidates: [] }];

  for (const { key, phrase, freq } of rows) {
    let nodeId = 0;
    for (const ch of key) {
      let nxt = nodes[nodeId].children.get(ch);
      if (nxt === undefined) {
        nxt = nodes.length;
        nodes[nodeId].children.set(ch, nxt);
        nodes.push({ children: new Map(), candidates: [] });
      }
      nodeId = nxt;
    }
    nodes[nodeId].candidates.push({ phrase, freq });
  }

  for (const node of nodes) {
    if (node.candidates.length > 0) {
      node.candidates.sort((a, b) => {
        if (b.freq !== a.freq) return b.freq - a.freq;
        if (a.phrase < b.phrase) return -1;
        if (a.phrase > b.phrase) return 1;
        return 0;
      });
    }
  }
  return nodes;
}

// â”€â”€â”€ Write binary table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function writeBinaryTable(nodes) {
  const encoder = new TextEncoder();
  const states = [];
  const edges = [];
  const candidates = [];
  const phraseChunks = [];
  let phraseBlobLen = 0;

  for (const node of nodes) {
    const edgeStart = edges.length;
    const orderedEdges = Array.from(node.children.entries()).sort((a, b) => a[0] < b[0] ? -1 : 1);
    for (const [ch, nextState] of orderedEdges) {
      edges.push({ charCode: ch.codePointAt(0), nextState });
    }

    const candStart = candidates.length;
    for (const { phrase, freq } of node.candidates) {
      const phraseBytes = encoder.encode(phrase);
      const phraseOffset = phraseBlobLen;
      phraseChunks.push(phraseBytes);
      phraseBlobLen += phraseBytes.length;
      if (phraseBytes.length > 65535) throw new Error("phrase byte length exceeds uint16 limit");
      candidates.push({ phraseOffset, phraseLen: phraseBytes.length, freq });
    }

    states.push({
      edgeStart,
      edgeCount: orderedEdges.length,
      candStart,
      candCount: node.candidates.length,
    });
  }

  const HEADER_SIZE = 28;
  const STATE_SIZE = 16;
  const EDGE_SIZE = 8;
  const CAND_SIZE = 7;

  const totalSize = HEADER_SIZE
    + states.length * STATE_SIZE
    + edges.length * EDGE_SIZE
    + candidates.length * CAND_SIZE
    + phraseBlobLen;

  const buffer = new ArrayBuffer(totalSize);
  const view = new DataView(buffer);
  const u8 = new Uint8Array(buffer);
  let offset = 0;

  u8.set(MAGIC, 0); offset += 8;
  view.setUint32(offset, VERSION, true); offset += 4;
  view.setUint32(offset, states.length, true); offset += 4;
  view.setUint32(offset, edges.length, true); offset += 4;
  view.setUint32(offset, candidates.length, true); offset += 4;
  view.setUint32(offset, phraseBlobLen, true); offset += 4;

  for (const s of states) {
    view.setUint32(offset, s.edgeStart, true); offset += 4;
    view.setUint32(offset, s.edgeCount, true); offset += 4;
    view.setUint32(offset, s.candStart, true); offset += 4;
    view.setUint32(offset, s.candCount, true); offset += 4;
  }

  for (const e of edges) {
    view.setUint32(offset, e.charCode, true); offset += 4;
    view.setUint32(offset, e.nextState, true); offset += 4;
  }

  for (const c of candidates) {
    view.setUint32(offset, c.phraseOffset, true); offset += 4;
    view.setUint16(offset, c.phraseLen, true); offset += 2;
    view.setUint8(offset, c.freq); offset += 1;
  }

  for (const chunk of phraseChunks) {
    u8.set(chunk, offset);
    offset += chunk.length;
  }

  return {
    buffer,
    stats: {
      stateCount: states.length,
      edgeCount: edges.length,
      candidateCount: candidates.length,
      phraseBlobBytes: phraseBlobLen,
    },
  };
}

// â”€â”€â”€ CSV generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateCSV(rows) {
  let csv = "input_keys,phrase,freq\n";
  for (const { key, phrase, freq } of rows) {
    const escapedPhrase = phrase.includes(",") || phrase.includes('"') || phrase.includes("\n")
      ? '"' + phrase.replace(/"/g, '""') + '"'
      : phrase;
    const escapedKey = key.includes(",") || key.includes('"')
      ? '"' + key.replace(/"/g, '""') + '"'
      : key;
    csv += `${escapedKey},${escapedPhrase},${freq}\n`;
  }
  return new Blob([csv], { type: "text/csv;charset=utf-8" });
}

// â”€â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function displayResults(stats, entryCount, nodeCount, binBuffer, csvBlob) {
  outputEl.classList.add("visible");
  const prefix = selectedFormat === "v2" ? "clawroot_v2" : "clawroot";

  statsEl.innerHTML = [
    ["è©æ¢æ•¸", entryCount.toLocaleString()],
    ["ç¯€é»æ•¸", nodeCount.toLocaleString()],
    ["é‚Šæ•¸", stats.edgeCount.toLocaleString()],
    ["å€™é¸æ•¸", stats.candidateCount.toLocaleString()],
    ["ç‰‡èª Blob", formatBytes(stats.phraseBlobBytes)],
    ["ç¢¼è¡¨å¤§å°", formatBytes(binBuffer.byteLength)],
  ].map(([label, value]) =>
    `<div class="stat"><div class="label">${label}</div><div class="value">${value}</div></div>`
  ).join("");

  const binBlob = new Blob([binBuffer], { type: "application/octet-stream" });

  downloadsEl.innerHTML = "";
  downloadsEl.appendChild(makeDownloadBtn(`${prefix}_table.bin`, binBlob, "ä¸‹è¼‰ .bin ç¢¼è¡¨"));
  downloadsEl.appendChild(makeDownloadBtn(`${prefix}_ios_ready.csv`, csvBlob, "ä¸‹è¼‰ .csv"));
}

function makeDownloadBtn(filename, blob, label) {
  const btn = document.createElement("button");
  btn.className = "btn-download";
  btn.textContent = label;
  btn.addEventListener("click", () => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  });
  return btn;
}

function showProgress(pct) {
  progressBar.classList.add("visible");
  progressFill.style.width = pct + "%";
  if (pct >= 100) setTimeout(() => progressBar.classList.remove("visible"), 600);
}

function resetOutput() {
  outputEl.classList.remove("visible");
  logEl.classList.remove("visible");
  logEl.innerHTML = "";
  progressBar.classList.remove("visible");
  progressFill.style.width = "0%";
}

function log(msg, type) {
  logEl.classList.add("visible");
  const div = document.createElement("div");
  if (type) div.className = type;
  div.textContent = msg;
  logEl.appendChild(div);
  logEl.scrollTop = logEl.scrollHeight;
}

function formatBytes(bytes) {
  if (bytes < 1024) return bytes + " B";
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
  return (bytes / 1048576).toFixed(2) + " MB";
}
</script>
</body>
</html>
